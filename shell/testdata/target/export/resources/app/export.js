!function(){var e=require("path"),n=(require("fs"),require("./util"));n.init({name:"export"},function(){function t(e,n){n?E.val(e||""):(E.val(E.val()+"\n"+e),E.scrollTop(E.get(0).scrollHeight),console.log(e))}function i(t,i){var r,a,o=arguments;if(3==o.length){var c=o[2];a=new Date,r=new Date,r.setDate(r.getDate()-c)}else r=new Date(o[2]),a=new Date(o[3]);for(;a>=r;){var l=a.format(i),s=e.join(t,l);if(n.file.exists(s)){var u=j.statSync(s).mtime;if(u>=r)return s}a.setDate(a.getDate()-1)}}function r(e){var n=e.val,t=n.dir_in,r=[t],a=n.file_rule,o=a.is_common;if(o){var c=a.val_common||{};r.push(c.prefix+c.date_format+c.postfix+"."+c.file_suffix)}else r.push(a.val_custom);var l=n.file,s=l.is_newest,u=l.val;return s?r.push(u.newest_days):(r.push(u.start),r.push(u.end)),i.apply(null,r)}function a(e){if(e.state.selected)return!0;var n=e.children;if(n)for(var t=0,i=n.length;i>t;t++)if(a(n[t]))return!0;return!1}function o(e){function n(e){if(!e)return null;var t=[];return e.forEach(function(e){var i={name:e.text};if(a(e)){if("default"==e.type){var r=n(e.children);r.length>0&&(i.childNodes=r)}t.push(i)}}),t}var t=e.get_json()[0].children;return n(t)}function c(i,a){function c(e){e.forEach(function(e){var n=e.childNodes;n?c(n):u.push(e.name)})}function l(){f++;var o=u.shift();if(!o)return i(e.join(P,".tree.json"),{type:O,val:s}),void(a&&a());try{var c=require(e.join(T,o))}catch(h){}if(c){var m=c.data.val;m.file={is_newest:!0,val:{newest_days:999}};var p=null;try{p=r(c.data)}catch(h){}if(n.file.exists(p)){var v=e.basename(p);i(e.join(H,v),{type:F,val:p}),t("	\u590d\u5236"+p),m.file_rule.is_common=!1,m.file_rule.val_custom=v}m.dir_in="",i(e.join(P,o+".json"),{type:O,val:c}),t(f+"/"+d+" \u6210\u529f\u5904\u7406"+o)}setImmediate(l,10)}var s=o(G),u=[];c(s);var f=0,d=u.length;l()}function l(i){var r=o(K),a=[],c={};r.forEach(function(e){c[e.name]=1}),L.forEach(function(i){if(c[i.name]){var r=[];i.maps.forEach(function(i){var a=i.file,o=e.basename(a);n.file.exists(a)?(n.file.copy(a,e.join(k,o)),i.file=o,r.push(i)):t(a+"\u4e0d\u5b58\u5728\uff01")}),r.length>0&&(i.maps=r,a.push(i))}}),i(e.join(P,".maps.json"),{type:O,val:a}),t("\u6210\u529f\u5bfc\u51fa"+a.length+"\u6761\u5730\u56fe\u914d\u7f6e\uff01")}function s(n){var i=o(Q),r=[],a={};i.forEach(function(e){a[e.name]=1}),U.forEach(function(e){a[e.name]&&r.push(e)}),n(e.join(P,".legend.json"),{type:O,val:r}),t("\u6210\u529f\u5bfc\u51fa"+r.length+"\u6761\u5730\u56fe\u914d\u7f6e\uff01")}function u(e,n){if(!e)return null;var t=[];return e.forEach(function(e){var i=e.name,r=u(e.childNodes,n+1);t.push({text:i,state:{opened:!0},children:r,type:r?"default":"file"})}),t}function f(){for(var e=[],n=0,t=L.length;t>n;n++)e.push({text:L[n].name});return e}function d(){for(var e=[],n=0,t=U.length;t>n;n++)e.push({text:U[n].name});return e}function h(e){var n=g("zip"),t=j.createWriteStream(e);return t.on("close",function(){console.log(n.pointer()+" total bytes"),v()}),n.on("error",function(e){throw e}),n.pipe(t),n}function m(e,n){var t=e.jstree({core:{themes:{stripes:!0},data:n,check_callback:!0},types:{"default":{icon:"jstree-themeicon-hidden test"},file:{valid_children:[],icon:"jstree-themeicon-hidden test"}},plugins:["contextmenu","types","unique","checkbox"]}).on("ready.jstree",function(e,n){var t=n.instance;t.check_all()});return t.jstree()}function p(t){function i(e,i){if(n.file.exists(e)){console.log(e);var r=j.createReadStream(e);t.append(r,{name:i})}}t.bulk({cwd:e.join(__dirname,"../../"),src:["*.*"]}),t.bulk({cwd:e.join(__dirname,"../../"),src:["locales/**/**"]},{name:"locales"}),t.append(require("./lib/asar_stream").getStream(e.join(__dirname,"../atom.asar")),{name:e.join(S,"atom.asar")}),i(e.join(__dirname,"import.html"),e.join(N,"import.html")),i(e.join(__dirname,"import.js"),e.join(N,"import.js")),i(e.join(__dirname,"util.js"),e.join(N,"util.js")),i(e.join(__dirname,"lib/j.js"),e.join(N,"lib/j.js")),B(t)(e.join(N,"package.json"),{type:O,val:{main:"import.js"}})}function v(){V.val(Y),t("------------- \u5bfc\u51fa\u6210\u529f! -------------"),x.showItemInFolder(M)}function _(){var i=a(G.get_json()[0]);if(!i)return A("\u6ca1\u6709\u8981\u5bfc\u51fa\u7684\u4ea7\u54c1\uff01");var r=a(K.get_json()[0]);if(!r)return A("\u6ca1\u6709\u8981\u5bfc\u51fa\u7684\u5730\u56fe\uff01");var o=a(Q.get_json()[0]);return o?(M=null,void n.ui.dialog.save(e.join("\u84ddPI\u5236\u56fe\u6d4b\u8bd5\u6570\u636e_"+(new Date).format("yyyy-MM-dd")+".zip"),function(e){M=e;var n=h(M),i=B(n),r=1;t("("+r++ +") \u6b63\u5728\u5bfc\u51fa\u4ea7\u54c1\u914d\u7f6e\u53ca\u76f8\u5173\u6570\u636e\u6587\u4ef6"),c(i,function(){t("("+r++ +") \u6b63\u5728\u5bfc\u51fa\u5730\u56fe\u914d\u7f6e\u53ca\u76f8\u5173\u6570\u636e\u6587\u4ef6"),l(i),t("("+r++ +") \u6b63\u5728\u5bfc\u51fa\u56fe\u4f8b\u914d\u7f6e"),s(i),p(n),n.finalize(),t("\u6b63\u5728\u5904\u7406\u538b\u7f29\u6587\u4ef6\uff1a"+M)})})):A("\u6ca1\u6709\u8981\u5bfc\u51fa\u7684\u56fe\u4f8b\uff01")}var j=require("fs"),g=require("archiver"),y=require("electron"),x=y.shell,b=require("./lib/j"),w=(require("./lib/j.tree"),b("#cb_product"),b("#cb_map"),b("#cb_legend"),b("#tree_product")),A=(b("#tree_map"),b("#tree_legend"),n.ui.checked,n.ui.dialog.alert),D=n.CONST,T=D.PATH_CONFIG_USER,k=(D.PATH_DATA,D.PATH_DATA_CONFIG,D.PATH_DATA_DATA,D.PATH_DATA_GEOFILE);process.on("uncaughtException",function(){var e="\u53d1\u751f\u9519\u8bef\uff0c\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458!";t(e),A(e)});var q=b("#log"),E=q.find("textarea"),S="resources",N=e.join(S,"app"),I=e.join(N,"data"),P=e.join(I,"config"),H=e.join(I,"data"),O=(e.join(I,"geo"),1),F=2,z=3,C=[{name:"\u5168\u90e8\u4ea7\u54c1",childNodes:n.getProductTree()||[]}];if(C){C=u(C,0)}var G,R=w.jstree({core:{themes:{stripes:!0},data:C,check_callback:!0},types:{"default":{icon:"jstree-themeicon-hidden test"},file:{valid_children:[],icon:"jstree-themeicon-hidden test"}},plugins:["contextmenu","types","unique","checkbox"]}).on("ready.jstree",function(){G=R.jstree(),G.check_all()});window.$tree=R;var M,J=n.getSys()||{},L=J.geo||[],U=J.legend||[],W=[{text:"\u5168\u90e8\u5730\u56fe",state:{opened:!0},children:f()}],$=[{text:"\u5168\u90e8\u56fe\u4f8b",state:{opened:!0},children:d()}],B=function(e){return function(n,t){var i,r=t.type,a=t.val;r==O?i=JSON.stringify(a):r==F?i=j.createReadStream(a):r==z&&(i=a),i&&e.append(i,{name:n})}},K=m(b("#tree_map"),W),Q=m(b("#tree_legend"),$),V=b("#btn_export").click(function(){V.val()!=X&&(t("",!0),V.val(X),setTimeout(_,10))}),X="\u6b63\u5728\u5904\u7406",Y=V.val()})}();