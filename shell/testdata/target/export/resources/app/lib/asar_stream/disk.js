(function(){var e,r,n,t,i,a,c,u;t=require("fs"),a=require("path"),i=require("./mkdirp"),c=require("./chromium-pickle-js"),e=require("./filesystem"),n={},r=function(e,r,n){var c,u,o,d;return u=a.join(r,n),d=a.join(e,n),c=t.readFileSync(u),o=t.statSync(u),i.sync(a.dirname(d)),t.writeFileSync(d,c,{mode:o.mode})},u=function(e,n,i,c,o){var d,f,l,s;if(0===c.length)return i.end(),o(null);if(f=c[0],f.unpack){l=a.relative(n.src,f.filename);try{r(""+e+".unpacked",n.src,l)}catch(y){return d=y,o(d)}return u(e,n,i,c.slice(1),o)}return s=t.createReadStream(f.filename),s.on("error",o),s.on("end",function(){return u(e,n,i,c.slice(1),o)}),s.pipe(i,{end:!1})},module.exports.writeFilesystem=function(e,r,n,i){var a,o,d,f,l,s;try{d=c.createEmpty(),d.writeString(JSON.stringify(r.header)),o=d.toBuffer(),s=c.createEmpty(),s.writeUInt32(o.length),l=s.toBuffer()}catch(y){return a=y,i(a)}return f=t.createWriteStream(e),f.on("error",i),f.write(l),f.write(o,function(){return u(e,r,f,n,i)})},module.exports.readArchiveHeaderSync=function(e){var r,n,i,a,u,o,d;r=t.openSync(e,"r");try{if(o=new Buffer(8),8!==t.readSync(r,o,0,8,null))throw new Error("Unable to read header size");if(d=c.createFromBuffer(o),u=d.createIterator().readUInt32(),i=new Buffer(u),t.readSync(r,i,0,u,null)!==u)throw new Error("Unable to read header")}finally{t.closeSync(r)}return a=c.createFromBuffer(i),n=a.createIterator().readString(),{header:JSON.parse(n),headerSize:u}},module.exports.readFilesystemSync=function(r){var t,i;return n[r]||(i=this.readArchiveHeaderSync(r),t=new e(r),t.header=i.header,t.headerSize=i.headerSize,n[r]=t),n[r]},module.exports.readFileSync=function(e,r,n){var i,c,u;if(i=new Buffer(n.size),n.size<=0)return i;if(n.unpacked)i=t.readFileSync(a.join(""+e.src+".unpacked",r));else{c=t.openSync(e.src,"r");try{u=8+e.headerSize+parseInt(n.offset),t.readSync(c,i,0,n.size,u)}finally{t.closeSync(c)}}return i}}).call(this);