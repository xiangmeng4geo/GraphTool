function readdir(e,i){if(fs.existsSync(e)){var t=asar.listPackage(e);return t.sort().forEach(function(e){var t=fs.lstatSync(e);t.isFile()?i[e]={type:"file",stat:t}:t.isDirectory()?i[e]={type:"directory",stat:t}:t.isSymbolicLink()&&(i[e]={type:"link",stat:t})}),t}return null}function readdir(e,i){if(fs.existsSync(e)){var t=fs.statSync(e);if(t.isDirectory()){var r=[],s=fs.readdirSync(e);return s.sort().forEach(function(t){var s=path.join(e,t),a=fs.lstatSync(s),n=!1;if(a.isFile()?i[s]={type:"file",stat:a}:(n=a.isDirectory())?i[s]={type:"directory",stat:a}:a.isSymbolicLink()&&(i[s]={type:"link",stat:a}),n){var l=readdir(s,i);l&&(r=r.concat(l))}r.push(s)}),r}}}function glob(e){var i={},t=readdir(e,i);return t.sort(),{filenames:t,metadata:i}}function listPackage(){return disk.readFilesystemSync(archive).listFiles()}function extractAll(e,i){var t,r,s,a,n,l,f,c,o,y,p,u,m,d,h;for(f=disk.readFilesystemSync(e),l=f.listFiles(),c="win32"===process.platform,mkdirp.sync(i),h=[],m=0,d=l.length;d>m;m++)if(n=l[m],n=n.substr(1),r=path.join(i,n),a=f.getFile(n,c),a.files)h.push(mkdirp.sync(r));else if(a.link){y=path.dirname(path.join(i,a.link)),o=path.dirname(r),u=path.relative(o,y);try{fs.unlinkSync(r)}catch(k){s=k}p=path.join(u,path.basename(a.link)),h.push(fs.symlinkSync(p,r))}else t=disk.readFileSync(f,n,a),h.push(fs.writeFileSync(r,t));return h}function initFileSystem(e,i,t){for(var r=new Filesystem(e),s=[],a=i,n=0,l=a.length;l>n;n++){filename=a[n],file=t[filename],file||(stat=fs.lstatSync(filename),stat.isDirectory()&&(type="directory"),stat.isFile()&&(type="file"),stat.isSymbolicLink()&&(type="link"),file={stat:stat,type:type});var f=!1;switch(file.type){case"directory":r.insertDirectory(filename,f);break;case"file":s.push({filename:filename,unpack:f}),r.insertFile(filename,f,file.stat);break;case"link":r.insertLink(filename,file.stat)}}return r._files=s,r}var fs=require("fs"),path=require("path"),stream=require("stream"),util=require("util"),Readable=stream.Readable,Filesystem=require("./filesystem"),disk=require("./disk"),mkdirp=require("./mkdirp"),pickle=require("./chromium-pickle-js"),PATH_TMP=require("os").tmpDir(),AsarReader=function(e,i){void 0===i&&(i={}),Readable.call(this,i),e=path.resolve(e);var t,r=path.basename(e);fs.statSync(e).isDirectory()?t=e:(t=path.join(PATH_TMP,r),extractAll(e,t));var s=glob(t);console.log("tmp_dir = "+t);var a=initFileSystem(t,s.filenames,s.metadata);this.filesystem=a;var n,l,f,c,o,y=this.queue_bf=[];try{f=pickle.createEmpty(),f.writeString(JSON.stringify(a.header)),l=f.toBuffer(),o=pickle.createEmpty(),o.writeUInt32(l.length),c=o.toBuffer(),y.push(c),y.push(l)}catch(p){n=p,console.log(n)}};util.inherits(AsarReader,Readable),AsarReader.prototype._read=function(){for(var e,i=this;e=i.queue_bf.shift();)i.push(e);for(var t;t=i.filesystem._files.shift();){var r=t.filename,s=fs.readFileSync(r);i.push(s)}i.push(null)},exports.getStream=function(e){return new AsarReader(e)};