!function(){function t(t){return n(i.join(v,t+p))}function e(t,e){s.writeFileSync(t,e),delete require.cache[t]}function n(t){return s.existsSync(t)?require(t):null}function r(t){return i.join(d,t+p)}var i=require("path"),s=require("fs"),a=require("os"),c=require("crypto"),o=(require("util").isArray,require("./micaps_parser/parser").parse),u=require("./micaps_parser/utils/raster2vector").raster2vector,y=i.join(__dirname,".."),f=process.cwd(),m=a.tmpdir(),p=".json",g=".png",l=i.dirname(f)!=m,S=i.dirname(l?y:process.execPath),h=l?y:i.dirname(process.execPath);Date.prototype.format=function(t,e){t||(t="yyyy-MM-dd hh:mm:ss");var n={"M{2}":this.getMonth()+1,"d{2}":this.getDate(),"h{2}":this.getHours(),"m{2}":this.getMinutes(),"q{2}":Math.floor((this.getMonth()+3)/3)};e||(n["s{2}"]=this.getSeconds(),n["S{2}"]=this.getMilliseconds()),/(y{4}|y{2})/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var r in n)new RegExp("("+r+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?n[r]:("00"+n[r]).substr((""+n[r]).length)));return t};var v=i.join(h,"conf"),d=i.join(S,"conf"),x={};["Sys","Verification"].forEach(function(e){x["get"+e]=function(){return t(e.toLowerCase())}}),x.write=function(t,n){return e(i.join(v,t+p),n)};var j="系统",w="sys_product_tree";x.get=t,x.User={getPath:r,getSys:function(){return this.get(j)},getTree:function(){var t=r(w);return n(t)},setTree:function(t){this.write(w,t)},get:function(t){var e=r(t),s=n(e),a=i.join(d,j+p);if(a!=e){var c=n(a);c&&(s||(s={other:{}}),!s.other.logo&&c.logos.company.flag&&(s.other.logo=c.logos.company.p),s.other.logo_southsea=c.logos.southsea,s.projector=c.projector)}return s},write:function(t,n,r){return r&&(n=JSON.stringify(n)),e(i.join(d,t+p),n)},rename:function(t,e){var n=r(t),i=r(e);try{s.renameSync(n,i)}catch(a){}}};var _={},D=function(t,e){return t&&t.toString?c.createHash("sha1").update(t.toString()+(e||"util")).digest("hex"):""};_.encrypt=D,!function(){function t(e){try{var n=i.dirname(e);return s.existsSync(n)||t(n),s.existsSync(e)||s.mkdirSync(e),!0}catch(r){}}function r(e,n){try{s.existsSync(n)?s.unlinkSync(n):t(i.dirname(n));for(var r=65536,a=new Buffer(r),c=s.openSync(e,"r"),o=s.openSync(n,"w"),u=1,y=0;u>0;)u=s.readSync(c,a,0,r,y),s.writeSync(o,a,0,u),y+=u;return s.closeSync(c),s.closeSync(o),!0}catch(f){}}function a(t,e){e||(e={});var n=e.is_not_recursive;if(s.existsSync(t)){var r=s.statSync(t);if(r.isDirectory()){var c=[],o=s.readdirSync(t),u=e.mtime;return o.sort().forEach(function(e){var r=i.join(t,e),o=s.statSync(r),y=o.isDirectory(),f={name:r};u&&(f.mtime=o.mtime),y&&!n&&(f.sub=a(r)),c.push(f)}),c}}}function c(t){try{if(s.existsSync(t)){var e=s.statSync(t);if(e.isDirectory()){var n=s.readdirSync(t);n.forEach(function(e){var n=i.join(t,e);s.statSync(n).isDirectory()?c(n):s.unlinkSync(n)}),s.rmdirSync(t)}else s.unlinkSync(t)}return!0}catch(r){}}function o(t,e){try{if(s.existsSync(t)){var n=s.readFileSync(t);return e?JSON.parse(n):n}}catch(r){}}var u=i.join(S,"tmp"),y={project:S,core:h,icon:i.join(S,"image/icon"),image:i.join(S,"image/bg"),tmp:u,tmp_micaps:i.join(u,"micaps"),tmp_legend:i.join(u,"legend")};for(var f in y)t(y[f]);t(d);var m={readdir:a,copy:r,mkdir:t,rm:c,path:y,exists:s.existsSync,readFile:o,stat:s.statSync,write:e,getJson:function(t,e){var r=n(t);e&&e(r)}};_.file=m}(),!function(){function t(t,e){var n,r,a=arguments;if(3==a.length){var c=a[2];r=new Date,n=new Date,n.setDate(n.getDate()-c)}else n=new Date(a[2]),r=new Date(a[3]);for(;r>=n;){var o=r.format(e),u=i.join(t,o);if(f.exists(u)){var y=s.statSync(u).mtime;if(y>=n)return u}r.setDate(r.getDate()-1)}}function n(t,e,n){var r=i.join(f.path.tmp_micaps,D(t+JSON.stringify(e)));s.existsSync(r)&&s.statSync(r).mtime>s.statSync(t).mtime?n&&n(null,f.readFile(r,!0),{path:r,iscache:!0}):o(t,e,function(e,i){e&&(i=f.readFile(t,!0),i&&(e=i.type?null:{code:101})),i&&s.writeFileSync(r,JSON.stringify(i)),n&&n(e,i,{path:r})})}function r(t,e,n){return i.join(f.path.tmp_legend,t+"_"+e+"x"+n+g)}function a(t){return i.join(d,t+p)}function c(t,e,n){var i=r(t,e,n),c=a(t);return s.existsSync(i)&&s.existsSync(c)&&s.statSync(i).mtime>s.statSync(c).mtime}function y(t,n){n=n.substring(n.indexOf("base64,")+7),n=new Buffer(n,"base64"),e(t,n)}var f=_.file,m=function(t,e,n){var r=(n?n.path:null)||null,a=r?i.join(f.path.tmp_micaps,D("raster2vector_"+e+"_"+r)):null;if(a&&r&&s.existsSync(a)&&s.existsSync(r)&&s.statSync(a).mtime>=s.statSync(r).mtime)return f.readFile(a,!0);var t=u(t,e);return a&&s.writeFileSync(a,JSON.stringify(t)),t};f.micaps={getNewest:t,getData:n,raster2vector:m},f.img={saveBase64:y},f.tmp={legend:{getPath:r,isNew:c,save:y}}}(),_.path=i,exports.util=_,exports.conf=x}();