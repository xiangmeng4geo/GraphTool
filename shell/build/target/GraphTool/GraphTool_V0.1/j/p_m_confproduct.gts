Core.safe(function(){function e(){var e=y;e.prop("checked")?(x.attr("disabled","disabled"),k.attr("disabled","disabled"),g.removeAttr("disabled")):(x.removeAttr("disabled"),k.removeAttr("disabled"),g.attr("disabled","disabled"))}function t(e){var t='<table cellspacing=1><tr><th width="10%">状态</th><th width="12%">颜色值</th><th width="12%">文字颜色</th><th width="30%">值域</th><th width="30%">显示文字</th><th width="6%" title="图例排列顺序\n从小到大排（图例倒序显示时从大到小）" class="cursor_help">顺序</th></tr>';return $.each(e,function(e,l){var i=l.color_text||"#000";t+='<tr><td><input type="checkbox" '+(l.is_checked?"checked":"")+'/></td><td><input type="color" value="'+l.color+'"/></td><td><input type="color" value="'+i+'"/></td><td contentEditable="true">'+l.val[0]+"~"+l.val[1]+'</td><td contentEditable="true" class="no_outline">'+l.text+'</td><td><input type="number" value="'+(l.order||0)+'"/></td>'}),t+="</table>"}function l(){var e=[];return Z.find(".fieldset_color").each(function(){var t=$(this),l={val:t.data("val_c"),color_start:t.find(".color_start").val(),color_end:t.find(".color_end").val(),is_stripe:t.find(".cb_is_stripe").prop("checked"),number_min:t.find(".number_min").val(),number_max:t.find(".number_max").val(),number_level:t.find(".number_level").val()},i=[];t.find("tr").each(function(e,t){var l=$(t).find("td");if(l.length>0){var a=l.eq(3).text().split("~");a.forEach(function(e,t){a[t]=isNaN(e)?0==t?r:o:parseFloat(e)}),i.push({is_checked:l.eq(0).find("input").prop("checked"),color:l.eq(1).find("input").val(),color_text:l.eq(2).find("input").val(),val:a,text:l.eq(4).text(),order:parseInt(l.eq(5).find("input").val())})}}),l.colors=i,e.push(l)}),e}function i(l){function i(e,t){e.find("option").each(function(){var e=$(this);e.val()==t&&e.attr("selected","selected")})}if(l){var o=l.file;o&&(x.val(o.time_start),k.val(o.time_end),y.prop("checked",o.is_newest),g.val(o.newest_days),e());var r=l.in_out;if(r){p.val(r.dir_in),h.val(r.dir_out);var _=r.file_rule,s=_.common;s&&(q.val(s.prefix),i(F,s.date_format),M.val(s.postfix),i(O,s.file_suffix)),T.val(_.custom),$("[name=file_rule]").filter("[value="+_.type+"]").prop("checked",!0),i($select_file_type,_.file_type),i($select_file_hour,_.file_hour),i($select_value_col,_.col);var d=r.out_filename||c+"_"+a+"x"+n+".png";tt.val(d)}var v=l.title;if(v){var u=v.title_1;G.text(u.text).attr("style",u.style),Y.prop("checked",u.is_show);var f=v.title_2;H.text(f.text).attr("style",f.style),z.prop("checked",f.is_show);var b=v.title_3;J.text(b.text).attr("style",b.style),B.prop("checked",b.is_show)}var m=l.legend;if(m){i(E,m.unit),W.prop("checked",m.is_show_legend),j.prop("checked",m.is_show_unit),K.prop("checked",m.is_reverse),Q.prop("checked",m.is_updown);var w=m.blendent;$.each(w,function(e,l){var i=l.val;L.add(i);var a=$(S.replace("_N_",i.n)).data("val_c",i);a.find(".color_start").val(l.color_start),a.find(".color_end").val(l.color_end),a.find(".cb_is_stripe").prop("checked",l.is_stripe),a.find(".number_min").val(l.number_min),a.find(".number_max").val(l.number_max),a.find(".number_level").val(l.number_level);var n=l.colors;n&&n.length>0&&(n.sort(function(e,t){return e.val[0]>t.val[0]?1:-1}),a.find(".legend_value").append(t(n))),D.append(a)})}var C=l.other;if(C){var N=C.bg_color;N&&(X.val(N.val),$cb_use_bgcolor.prop("checked",N.flag));var A=C.logo;A&&V.val(A);var I=C.bg_img;I&&(et.val(I.val),$cb_use_bgimg.prop("checked",I.flag));var R=C.interpolation;R&&$cb_interpolation_all.prop("checked",R.flag)}}}var a,n,o=99999,r=-9999,c="",_=Core.Lib,s=_.util.file,d=_.conf.User,v=Core.Window,u=Core.Const.msgType;$(".file_dir").click(function(){$(this).parent().prev().click()}),$(".file_dir_nw").on("change",function(){var e=$(this);e.next().find(".text_file_dir").val(e.val())});var f,p=$("#text_file_dir_in"),h=$("#text_file_dir_out");$("#fieldset_title input[type=button]").click(function(){f=$(this).prev("textarea");var e=Core.Page.textStyle(function(){v.sendMsg(u.CONF_STYLE,{text:f.val(),style:f.attr("style")},e.window)})});var b=$('<input type="file"/>').on("change",function(){var e=l();e.length>0?(s.write($(this).val(),JSON.stringify(e)),alert("配色方案导出成功！")):alert("暂时没有可导出的配色方案！")}),m=$('<input type="file"/>').on("change",function(){var e=$(this).val(),l=s.readFile(e,!0);$(".btn_dele_lengend").click(),$.each(l,function(e,l){var i=L.add(l.val),a=$(S.replace("_N_",i.n)).data("val_c",i).appendTo(D);a.find(".color_start").val(l.color_start),a.find(".color_end").val(l.color_end),a.find(".cb_is_stripe").prop("checked",l.is_stripe),a.find(".number_min").val(l.number_min),a.find(".number_max").val(l.number_max),a.find(".number_level").val(l.number_level),a.append(t(l.colors))})});$("#bt_export_colors").click(function(){b.click()}),$("#bt_import_colors").click(function(){m.click()});var g=$("#number_newest_days"),x=$("#date_start"),k=$("#date_end"),y=$("#cb_is_newest").click(e);v.onMessage(function(e){var t=e.data,l=t.type;if(u.CONF_STYLE==l){if(t=t.data,f){var o=t.style,r=t.text;f.val(r).attr("style",o),f.css("line-height",f.css("font-size"))}f=null}else if(u.CONF_PRODUCT==l&&(t=t.data)){c=t.name,a=t.width,n=t.height,$("title").text(c),b.attr("nwsaveas",c+"(配色方案).db");var _=d.get(c);i(_)}},!0);var w=$("#c_bottom > fieldset"),C=$("#c_top li").click(function(){var e=$(this);C.removeClass("on"),e.addClass("on"),w.removeClass("on"),w.eq(e.index()).addClass("on")}),N=$("#radio_file_rule_common"),T=($("#radio_file_rule_custom"),$("#text_file_rule_custom")),q=$("#text_file_rule_common_prefix"),F=$("#select_file_rule_common_date"),M=$("#text_file_rule_common_postfix"),O=$("#select_file_rule_common_postfix");$file_rule_example_span=$("#file_rule_example span"),$select_file_type=$("#select_file_type"),$select_file_hour=$("#select_file_hour"),$select_value_col=$("#select_value_col"),$cb_use_bgcolor=$("#cb_use_bgcolor"),$cb_use_bgimg=$("#cb_use_bgimg"),$cb_interpolation_all=$("#cb_interpolation_all"),!function(){function e(){var t="";t=N.prop("checked")?q.val()+F.val()+M.val()+"."+O.val():T.val(),t=t&&(new Date).format(t,!0);var l=p.val();l&&(l+="\\"),$file_rule_example_span.text(l+t),setTimeout(e,100)}var t=Core.Const.fileRule,l=t.col_index,i=t.time_rule,a=t.file_postfix,n=t.file_type,o=t.file_hour,r="";$.each(i,function(e,t){r+='<option value="'+t+'">'+t+"</option>"}),F.html(r);var c="";$.each(a,function(e,t){c+='<option value="'+t+'">'+t+"</option>"}),O.html(c);var _="";for(var s in n){var d=n[s];_+='<option value="'+d.v+'">'+d.n+"</option>"}$select_file_type.html(_);var v="";$.each(o,function(e,t){v+='<option value="'+t+'">'+t+"</option>"}),$select_file_hour.html(v);for(var u="",s=l[0],f=l[1];f>=s;s++)u+='<option value="'+s+'">'+s+"</option>";$select_value_col.html(u);var p=$("#text_file_dir_in");e()}();var A="";$.each(Core.Const.legend.unit,function(e,t){A+='<option value="'+t+'">'+t+"</option>"});var E=$("#select_legend_unit").html(A),I=$("#btn_add_new_legend").click(function(){var e=L.add();$(S.replace("_N_",e.n)).data("val_c",e).appendTo(D)}),L=function(){function e(e){for(var t=0,l=i.length;l>t;t++){var a=i[t];if(a.n==e.n&&a.v==e.v)return!0}}function t(){var t="";$.each(l,function(l,i){e(i)&&(t+='<option value="'+i.v+'">'+i.n+"</option>")}),a.html(t)}var l=Core.Const.legend.product,i=l.slice(0),a=$("#select_legent_product");return t(),{add:function(e){if(e)var t=a.find("option[value="+e.v+"]");else var t=$(a.get(0).selectedOptions);t.remove(),0==a.find("option").length&&(a.html("<option>暂无可添加的产品配色</option>"),a.attr("disabled","disabled"),I.attr("disabled","disabled"));for(var l=t.text(),n=t.val(),o=0,r=i.length;r>o;o++){var c=i[o];if(c.n==l&&c.v==n)return i.splice(o,1)[0]}},rm:function(e){a.removeAttr("disabled"),I.removeAttr("disabled"),i.push(e),t()}}}(),S='<fieldset class="fieldset_color"><legend>_N_ <input type="button" class="admin btn_dele_lengend" value="删除"/></legend><div class="legend_value"><form id="form_legend"><div class="mt10"><label>起始颜色</label><input type="color" value="#0000ff" class="color_start"/><label>终止颜色</label><input type="color" value="#ff0000" class="color_end"/><label title="雨夹雪时可使用">条纹显示</label><input type="checkbox" class="cb_is_stripe"/></div><div class="mt10"><label>最小值</label><input type="number" value="0" class="number_min"/><label>最大值</label><input type="number" value="40" class="number_max"/><label>等级数</label><input type="number" value="10" class="number_level"/><input value="生成等阶颜色值" type="button" class="btn_gen_colors"/></div></form></div></fieldset>',D=$(".legend_left");D.delegate(".btn_dele_lengend","click",function(){var e=$(this),t=e.closest("fieldset");L.rm(t.data("val_c")),t.remove()});var R=Core.Color.toRGB,P=Core.Color.toHTML;D.delegate("form","submit",function(e){return e.preventDefault(),!1});var U=function(e){return e.toFixed(e%1>0?1:0)};D.delegate(".btn_gen_colors","click",function(){for(var e=$(this).closest(".legend_value"),l=e.find(".number_min"),i=e.find(".number_max"),a=e.find(".number_level"),n=e.find(".color_start"),c=e.find(".color_end"),_=R(n.val(),!0),s=R(c.val(),!0),d=parseInt(a.val()),v=_[0],u=_[1],f=_[2],p=Number(l.val()),h=d+2,b=Math.floor((s[0]-v)/h),m=Math.floor((s[1]-u)/h),g=Math.floor((s[2]-f)/h),x=(Number(i.val())-p)/d,k=[],y=0;h>y;y++){var w=P("rgb("+[v+b*y,u+m*y,f+g*y]+")");if(0==y)var C=[r,U(p)],N="<"+C[1];else if(y==h-1)var C=[U(p+x*(y-1)),o],N=C[0]+"≤";else var C=[U(p+x*(y-1)),U(p+x*y)],N=C[0]+"-"+C[1];k.push({is_checked:!0,color:w,val:C,text:N})}e.find("table").remove(),e.append(t(k))});var Y=$("#cb_title_1"),z=$("#cb_title_2"),B=$("#cb_title_3"),G=$("#textarea_title_1"),H=$("#textarea_title_2"),J=$("#textarea_title_3"),W=$("#cb_is_show_legend"),j=$("#cb_is_show_unit"),K=$("#cb_is_reverse"),Q=$("#cb_is_updown"),V=$("#text_file_logo"),X=$("#color_bg"),Z=$("#fieldset_legend"),et=$("#text_file_bgimg"),tt=$("#text_out_filename");$("#btn_cancel").click(v.close),$("#btn_save").click(function(){var e={file:{time_start:x.val(),time_end:k.val(),is_newest:y.prop("checked"),newest_days:parseInt(g.val())||0},in_out:{dir_in:p.val(),dir_out:h.val(),file_rule:{common:{prefix:q.val(),date_format:F.val(),postfix:M.val(),file_suffix:O.val()},custom:T.val(),type:$("[name=file_rule]:checked").val(),file_type:$select_file_type.val(),file_hour:parseInt($select_file_hour.val())||0,col:parseInt($select_value_col.val())},out_filename:tt.val()},title:{title_1:{is_show:Y.prop("checked"),text:G.val(),style:G.attr("style")||""},title_2:{is_show:z.prop("checked"),text:H.val(),style:H.attr("style")||""},title_3:{is_show:B.prop("checked"),text:J.val(),style:J.attr("style")||""}},legend:{unit:E.val(),is_show_legend:W.prop("checked"),is_show_unit:j.prop("checked"),is_reverse:K.prop("checked"),is_updown:Q.prop("checked")},other:{logo:V.val(),bg_img:{val:et.val(),flag:$cb_use_bgimg.prop("checked")},bg_color:{val:X.val(),flag:$cb_use_bgcolor.prop("checked")},interpolation:{flag:$cb_interpolation_all.prop("checked")}}};e.legend.blendent=l(),d.write(c,e,!0),v.close()})});