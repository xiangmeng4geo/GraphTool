!function(t){function r(t,r,n){this.id=t+"_"+r,this.x=t,this.y=r,this.dir=n}function n(t){this.id=H++,this.points=[],this.type=t||E,this.numOfUsed=0,this.dir=1}function i(t,r){this.arc=t,this.dir=r}function e(){this.id=J++,this.arcDirs=[]}function a(t,r,n){this.arc=t,this.angle=r,this.dir=n}function s(t,r,n){var i=t.x,e=t.y,a=r.x,s=r.y,o=n.x,u=n.y,h=Math.pow(i-a,2)+Math.pow(e-s,2),l=Math.pow(a-o,2)+Math.pow(s-u,2),f=Math.pow(i-o,2)+Math.pow(e-u,2),p=(h+l-f)/(2*Math.sqrt(h)*Math.sqrt(l)),c=Math.acos(p),v=2*k-c,g=0,d=0;if(e!=s){if(g=(a-i)/(e-s),d=(i*s-a*e)/(e-s),e>s)return 0>=o+g*u+d?c:v;if(s>e)return 0>=o+g*u+d?v:c}else{if(a>i)return e>u?c:v;if(i>a)return e>u?v:c}return 10}function o(t){for(var r=0,n=0,i=t.length-1;i>n;n++){var e=t[n],a=t[n+1];r+=e.lng*a.lat-a.lng*e.lat}var e=t[i],a=t[0];return r+=e.lng*a.lat-a.lng*e.lat,r/2}function u(t,n){var i=B[t][n],e=B[t+1][n+1],a=i.c,s=B[t+1][n].c,o=B[t][n+1].c,u=e.c,h=[];a!=s&&h.push(O),u!=s&&h.push(q),u!=o&&h.push(U),a!=o&&h.push(_);var l=h.length,f=new r(t,n,h);f.lng=i.x+(e.x-i.x)/2,f.lat=i.y+(e.y-i.y)/2,l>2?(f.type=A,K.push(f)):2==l&&(f.type=R,L.push(f))}function h(t,r,n){var i=[];return z.isInsidePolygon(n,t+N,r+N)&&i.push(B[t][r].c),z.isInsidePolygon(n,t+1+N,r+N)&&i.push(B[t+1][r].c),z.isInsidePolygon(n,t+N,r+1+N)&&i.push(B[t][r+1].c),z.isInsidePolygon(n,t+1+N,r+1+N)&&i.push(B[t+1][r+1].c),i}function l(){for(var t=0;C-1>t;t++)for(var r=0;G-1>r;r++)u(t,r)}function f(t,r){for(var n=0,i=L.length;i>n;n++){var e=L[n];if(e.x==t&&e.y==r){var a=L.splice(n,1);return a[0]}}for(var n=0,i=K.length;i>n;n++){var e=K[n];if(e.x==t&&e.y==r)return e}}function p(t,r){for(var n=t.dir,i=0,e=n.length;e>i;i++)if(n[i]==-r)return void n.splice(i,1)}function c(t){for(var r=t.points,n=0,i=r.length;i>n;n++){var e=r[n].id;(T[e]||(T[e]=[])).push(t)}}function v(){for(var t;t=K.shift();)for(var r,i=t.dir;r=i.shift();){var e=t.x,a=t.y,s=new n,o=s.points;r==O?a--:r==q?e++:r==U?a++:r==_&&e--,o.push(t);for(var u,h=e,l=a,v=r;u=f(h,l);){if(o.push(u),u.type==A){p(u,v);break}var g=u.dir;if(g=g[g[0]==-v?1:0],h=u.x,l=u.y,g==O?l--:g==q?h++:g==U?l++:g==_&&h--,v=g,t.is(h,l)){o.push(t),p(t,v),s.type=j;break}}b(s),s.type==j?S.push(s):(Q.push(s),c(s))}for(var d;d=L.shift();){var s=new n(j),o=s.points,r=d.dir[0],e=d.x,a=d.y;r==O?a--:r==q?e++:r==U?a++:r==_&&e--,o.push(d);for(var u;u=f(e,a);){o.push(u);var i=u.dir;if(r=i[i[0]==-r?1:0],e=u.x,a=u.y,r==O?a--:r==q?e++:r==U?a++:r==_&&e--,d.is(e,a))break}b(s),S.push(s)}}function g(t){Y=[];var r,n,i=t,e=t.points,o=t.id;1==t.dir?(n=e.slice(-2)[0],r=e.slice(-1)[0]):(n=e[1],r=e[0]);for(var u=r.id,h=T[r.id],l=0,f=h.length;f>l;l++){var p=h[l];if(p.id!=o&&p.numOfUsed<=2){var c,v,g,d=p.points;d[0].id==u?(v=d[1],g=1):(v=d.slice(-2)[0],g=-1),c=s(n,r,v),Y.push(new a(p,c,g))}}if(0==Y.length)return i;X=Y[0];for(var y=X.angle,l=1,f=Y.length;f>l;l++){var x=Y[l],b=x.angle;y>b&&(y=b,X=x)}return X.arc}function d(t){var r=new e,n=r.arcDirs,a=[],s=new i(t,t.dir);a.push(t.id),n.push(s);for(var o=g(t),u=null;;){if(o.id==t.id)break;if(u&&u.id==o.id){for(var h=0,l=n.length;l>h;h++)n[h].arc.numOfUsed--;return null}u=o,o.dir=X.dir,o.numOfUsed+=1;var f=new i(o,o.dir);n.push(f),a.push(f.id),o=g(o)}return t.numOfUsed+=1,a.sort(function(t,r){return t-r}),r.key=a.join(","),r}function y(t){var r=d(t);if(r){V.push(r);for(var n=0,i=Q.length;i>n;n++){var e=Q[n];if(1==e.numOfUsed){if(e.dir*=-1,r=d(e),!r)return;V.push(r),n=0}}}}function x(t){for(var r={},n={},i=0,e=t.length;e>i;i++)for(var a=t[i],s=h(a.x,a.y,t),o=0,u=s.length;u>o;o++){var l=s[o];r[l]||(r[l]=0),r[l]++,(n[l]||(n[l]=[])).push(a)}var f=[];for(var i in r)f.push({c:i,n:r[i],p:n[i]});return f}function b(t){for(var r,n,i,e,a=t.points.slice(),s=(a.length,[]);i=a.shift();){if(e){var o=!!(i.x-e.x),u=!!(i.y-e.y);o==r&&u==n&&s.pop(),s.push(i),r=o,n=u}else s.push(i);e=i}t.points=s}function M(t){for(var r=[],n=[],i=0,e=t.length;e>i;i++)1==t[i].type&&n.push(i);if(n.length<=1)r.push(t);else{var a=n[0];0!=a&&r.push(t.slice(0,a));for(var i=0,e=n.length;e>i&&e>i+1;i++)a=n[i+1],r.push(t.slice(n[i],a));a<t.length&&r.push(t.slice(a))}for(var s=[],o=0,i=0,e=r.length;e>i;i++){o+=r[i].length;var u=null;u=e>i+1?r[i+1][0]:r[0][0],r[i].push(u);var h=$(r[i],t),l=h.length;if(l>0){var f=h[l-1];u&&f.lng==u.lng&&f.lat==u.lat&&h.pop()}s=s.concat(h)}return s}function w(){for(var t=V.length-1;t>=0;t--){var r=V[t];r.items=M(r.items)}}function m(){for(var t,r=[];t=V.shift();){for(var n=[],i=t.arcDirs,e=0,a=i.length;a>e;e++){var s=i[e],o=s.arc.points.slice();-1==s.dir&&o.reverse();try{n[n.length-1].id==o[0].id&&o.shift()}catch(u){}n=n.concat(o)}n.pop();var h=Z(n);null!==h&&r.push(h)}for(var l=0,f=S.length;f>l;l++){var n=S[l].points,h=Z(n);null!==h&&r.push(h)}return r.sort(function(t,r){return Math.abs(r.area)-Math.abs(t.area)||t.id-r.id}),r.shift(),V=r,r}function I(){for(var t=0,r=Q.length;r>t;t++){var n=Q[t];0==n.numOfUsed&&y(n)}}function F(t){for(var r=t.id,n=[],i=0,e=V.length;e>i;i++)for(var a=V[i],s=0,o=a.items,u=o.length;u>s;s++){var h=o[s].id;if(h==r){n.push(a);break}}return n}function D(t){for(var r=[],n={},i=0,e=t.length;e>i;i++){var a=t[i];n[a.key]||(n[a.key]=1,r.push(a))}return r}function P(){H=0,J=0,K=[],L=[],Q=[],S=[],T={},V=[],Z.reset(),$.reset()}var k=Math.PI,O=1,q=2,U=-1,_=-2,A=1,R=2,j=1,E=2,N=-.1,z=t.utils;"undefined"==typeof z&&(z=require("../utils"));var B,C,G,H=0,J=0,K=[],L=[],Q=[],S=[],T={},V=[],W=(function(){function t(t,r,n,i,e,a,s){var o=.5*(n-t),u=.5*(i-r);return(2*(r-n)+o+u)*s+(-3*(r-n)-2*o-u)*a+o*e+r}var r={distance:function(t,r){return Math.sqrt(Math.pow(t.lng-r.lng,2),Math.pow(t.lat-r.lat,2))}};return function(n,i,e){var a=n.length;if(1>=a)return n;e||(e=5);for(var s=[],o=0,u=1;a>u;u++)o+=r.distance(n[u-1],n[u]);var h=o/e;h=a>h?a:h;for(var u=0;h>u;u++){var l,f,p,c=u/(h-1)*(i?a:a-1),v=Math.floor(c),g=c-v,d=n[v%a];i?(l=n[(v-1+a)%a],f=n[(v+1)%a],p=n[(v+2)%a]):(l=n[0===v?v:v-1],f=n[v>a-2?a-1:v+1],p=n[v>a-3?a-1:v+2]);var y=g*g,x=g*y;s.push({lng:t(l.lng,d.lng,f.lng,p.lng,g,y,x),lat:t(l.lat,d.lat,f.lat,p.lat,g,y,x)})}return s}}(),function(){var t=function(t,r,n){if(n){this.points=[];for(var i=0;i<t.length;i++)this.points.push(t[i])}else this.points=t;this.degree=r,this.dimension=t[0].length,2==r?(this.baseFunc=this.basisDeg2,this.baseFuncRangeInt=2):3==r?(this.baseFunc=this.basisDeg3,this.baseFuncRangeInt=2):4==r?(this.baseFunc=this.basisDeg4,this.baseFuncRangeInt=3):5==r&&(this.baseFunc=this.basisDeg5,this.baseFuncRangeInt=3)};return t.prototype.seqAt=function(t){var r=this.points,n=this.degree+1;return function(i){return n>i?r[0][t]:r.length+n<=i?r[r.length-1][t]:r[i-n][t]}},t.prototype.basisDeg2=function(t){return t>=-.5&&.5>t?.75-t*t:t>=.5&&1.5>=t?1.125+(-1.5+t/2)*t:t>=-1.5&&-.5>t?1.125+(1.5+t/2)*t:0},t.prototype.basisDeg3=function(t){return t>=-1&&0>t?2/3+(-1-t/2)*t*t:t>=1&&2>=t?4/3+t*(-2+(1-t/6)*t):t>=-2&&-1>t?4/3+t*(2+(1+t/6)*t):t>=0&&1>t?2/3+(-1+t/2)*t*t:0},t.prototype.basisDeg4=function(t){return t>=-1.5&&-.5>t?55/96+t*(-(5/24)+t*(-1.25+(-(5/6)-t/6)*t)):t>=.5&&1.5>t?55/96+t*(5/24+t*(-1.25+(5/6-t/6)*t)):t>=1.5&&2.5>=t?625/384+t*(-(125/48)+t*(25/16+(-(5/12)+t/24)*t)):t>=-2.5&&-1.5>=t?625/384+t*(125/48+t*(25/16+(5/12+t/24)*t)):t>=-1.5&&1.5>t?115/192+t*t*(-0.625+t*t/4):0},t.prototype.basisDeg5=function(t){return t>=-2&&-1>t?.425+t*(-0.625+t*(-1.75+t*(-1.25+(-0.375-t/24)*t))):t>=0&&1>t?.55+t*t*(-.5+(.25-t/12)*t*t):t>=2&&3>=t?2.025+t*(-3.375+t*(9/4+t*(-.75+(1/8-t/120)*t))):t>=-3&&-2>t?2.025+t*(27/8+t*(9/4+t*(.75+(1/8+t/120)*t))):t>=1&&2>t?.425+t*(5/8+t*(-1.75+t*(5/4+(-0.375+t/24)*t))):t>=-1&&0>t?.55+t*t*(-.5+(.25+t/12)*t*t):0},t.prototype.getInterpol=function(t,r){for(var n=this.baseFunc,i=this.baseFuncRangeInt,e=Math.floor(r),a=0,s=e-i;e+i>=s;s++)a+=t(s)*n(r-s);return a},t.prototype.calcAt=function(t){return t*=2*(this.degree+1)+this.points.length,{lng:this.getInterpol(this.seqAt("lng"),t).toFixed(4),lat:this.getInterpol(this.seqAt("lat"),t).toFixed(4)}},function(r,n,i){n=n||4;var e=r.length,a=e*(i||5);20>a&&(a=20);for(var s=new t(r,n,!0),o=[],u=1/a,h=0;1>=h;h+=u){var l=s.calcAt(h);o.push(l)}return o}}());r.prototype.is=function(t,r){return this.id==t+"_"+r},t._getEndPoints=function(){return K},t._getNodePoints=function(){return L};var X,Y=[],Z=function(){var t={},r=0,n=function(n){var i=n.length,e=o(n),a=i+"_"+Math.abs(e),s={items:n,area:e,id:r++};if(t[a]){for(var u=t[a],h=n.slice(-1)[0].id,l=n[0].id,f=0,p=u.length;p>f;f++){var c=u[f];if(c.area==-e){var v=c.items,g=v.indexOf(l),d=g==v.length-1?0:g+1;if(v[d].id==h.id)return null}}t[a].push(s)}else t[a]=[s];return s};return n.reset=function(){t={},r=0},n}(),$=function(){var t={},r=Math.pow(.05,2),n=.2,i=function(i,e){var a=i.length;if(2==a){var s,o,u=i[0],h=i[1],l=u.x,f=u.y,p=h.x,c=h.y,v=u.lng,g=u.lat,d=h.lng,y=h.lat;if(l==p){var x=(f-c)*n,b=(g-y)*n,M=f+(c-f)/2,w=g+(y-g)/2;s={x:l+x,y:M,lng:d+b,lat:w},o={x:l-x,y:M,lng:d-b,lat:w}}else{var x=(l-p)*n,m=(v-d)*n,I=l+(p-l)/2,F=v+(d-v)/2;s={x:I,y:f+x,lng:F,lat:y+m},o={x:I,y:f-x,lng:F,lat:y-m}}var D=z.isInsidePolygon(e,s.x,s.y)?o:s;i=[u,D,h],a=3}if(a>=3){var P=i[0].id,k=i[a-1].id,O=P+","+k+","+a,q=t[O];if(q)return q;var U=k+","+P+","+a;if(q=t[U])return q.reverse(),q;for(var _=W(i,5),A=_.shift(),R=[A],j=1,E=_.length;E>j;j++){var x=_[j];Math.pow(A.lng-x.lng,2)+Math.pow(A.lat-x.lat,2)>=r&&(R.push(x),A=x)}var N=R[0],B=R[R.length-1];return Math.pow(N.lng-B.lng,2)+Math.pow(N.lat-B.lat,2)<r&&R.pop(),t[O]=R,R}return i};return i.reset=function(){t={}},i}(),tr=function(t){for(var r=[],n=0,i=t.length;i>n;n++){var e=t[n],a=x(e.items);if(1==a.length)e.color=a[0].c;else{a.sort(function(t,r){return t.n-r.n});var s=a.pop();e.color=s.c,r.push({i:n,p:e,colors:a})}}for(var n=0,i=r.length;i>n;n++){for(var e=r[n],o=e.p.items,u=e.p.id,h=e.p.color,a=e.colors,l=[],f=0,p=a.length;p>f;f++){for(var c=a[f],v=c.p,g=[],d=0,y=v.length;y>d;d++)g=g.concat(F(v[d],u));l=l.concat(D(g))}l=D(l);for(var b=[],M=0,w=l.length;w>M;M++){var m=l[M];m.id!=u&&h!=m.color&&z.polygonIsInsidePolygon(o,m.items)&&b.push(m)}b.length>0&&(e.p.clip=b)}},rr=function(t,r){C=t.length,G=t[0].length;for(var n=0;C>n;n++)for(var i=t[n],e=0;G>e;e++){var a=i[e];(0==n||0==e||n==C-1||e==G-1)&&(a.c=r)}B=t,l()};t.raster2vector=function(t,r){return P(),rr(t,r),v(),I(),m(),tr(V),w(),V}}("undefined"==typeof __dirname?this:exports);