function _parse_file(e){var i=/^(-?[\d.]+)\s+([\d.]+)$/,a=/^([\d.]+)\s+([\d.]+)\s+([\d.]+)$/,s=/^LINES: (\d+)/,t=/^LINES_SYMBOL: (\d+)/,n=/^SYMBOLS: (\d+)/,r=/^CLOSED_CONTOURS: (\d+)/,l=/\s+/,o={len:0,items:[]},_={len:0,items:[]},m={len:0,items:[]},f={len:0,items:[]},c={lines:o,line_symbols:_,symbols:m,areas:f},v=2,d=3,h=4,E=5;FLAG_LINES_SYMBOLE=6,FLAG_LINES_SYMBOLE_POINTS=7,FLAG_SYMBOLE=8,FLAG_SYMBOLE_ITEM=9,FLAG_OVER=10,FLAG_AREA_POINTS_INFO=11,FLAG_AREA_POINTS=12,FLAG_AREA_LABEL_INFO=13,FLAG_AREA_LABEL=14;var A,g;e.forEach(function(e,c){if(e=e.trim(),g=s.exec(e))return o.len=g[1],g=null,void(A=v);if(g=t.exec(e))return _.len=g[1],g=null,void(A=FLAG_LINES_SYMBOLE);if(g=n.exec(e))return m.len=g[1],g=null,void(A=FLAG_SYMBOLE_ITEM);if(g=r.exec(e))return f.len=g[1],g=null,void(A=FLAG_AREA_POINTS_INFO);if(A!=FLAG_OVER)if(A==v){var u=i.exec(e);u&&o.items.push({weight:u[1],point:{len:u[2],items:[]},flags:{len:0,text:"",items:[]}}),A=d}else if(A==d||A==E||A==FLAG_LINES_SYMBOLE_POINTS||A==FLAG_AREA_POINTS||A==FLAG_AREA_LABEL){var L=[],y=e.split(l);if(y.length%3!=0)return;for(var c=0,O=y.length;O>c;c+=3){var I={x:Number(y[c]),y:Number(y[c+1]),z:Number(y[c+2])};L.push(I)}if(A==d){var x=o.items[o.items.length-1];x.point.items=x.point.items.concat(L),x.point.len==x.point.items.length&&(A=h)}else if(A==E){var x=o.items[o.items.length-1];x.flags.items=x.flags.items.concat(L),x.flags.len==x.flags.items.length&&(A=v)}else if(A==FLAG_LINES_SYMBOLE_POINTS){var N=_.items[_.items.length-1];N.items=N.items.concat(L),N.items.length==N.len&&(A=FLAG_LINES_SYMBOLE)}else if(A==FLAG_AREA_POINTS){var p=f.items[f.items.length-1];p.items=p.items.concat(L),p.items.length==p.len&&(A=FLAG_AREA_LABEL_INFO)}else if(A==FLAG_AREA_LABEL){var p=f.items[f.items.length-1],b=p.symbols;b.items=b.items.concat(L),b.items.length==b.len&&(A=FLAG_AREA_POINTS_INFO),f.items.length==f.len&&(A=FLAG_OVER)}}else if(A==h){var u=i.exec(e);if(u){var S=o.items[o.items.length-1].flags;S.text=u[1],S.len=u[2],A=E}}else if(A==FLAG_LINES_SYMBOLE){var u=a.exec(e);u&&(_.items.push({code:Number(u[1]),weight:Number(u[2]),len:Number(u[3]),items:[]}),A=FLAG_LINES_SYMBOLE_POINTS)}else if(A==FLAG_SYMBOLE_ITEM){var M=e.split(l);m.items.push({type:Number(M[0]),x:Number(M[1]),y:Number(M[2]),z:Number(M[3]),text:M[4]}),m.items.length==m.len&&(A=FLAG_OVER)}else if(A==FLAG_AREA_POINTS_INFO){var u=i.exec(e);u&&(f.items.push({weight:Number(u[1]),len:Number(u[2]),items:[]}),A=FLAG_AREA_POINTS)}else if(A==FLAG_AREA_LABEL_INFO){A=FLAG_AREA_POINTS_INFO;var u=i.exec(e);if(u){var p=f.items[f.items.length-1];p.symbols={text:u[1],len:Number(u[2]),items:[]},A=FLAG_AREA_LABEL}}});var u=c.areas.items;return u.forEach(function(e){var i=e.items;e.area=_get_acreage(i)}),c.areas.len>0&&c.line_symbols.len>0&&_parseArea(c),_sort_areas(c.areas),_format(c),c}function _parseArea(e){var i={},a=e.line_symbols.items.filter(function(e){return 0==e.code});_sort_areas(e.areas),_add_area_code(e);var s=e.areas.items;s.forEach(function(e,s){var t=e.items;a.forEach(function(e,a){lineIsInsidePolygon(t,e.items,!0)&&(i[s]||(i[s]=[]),i[s].push(a))})});var t={};for(var n in i){for(var r=i[n],l=s[n],o=[];r.length>0;){var _=r.shift(),m=a[_].items.slice(),f=o.length;if(f>0)for(var c=0;f>c;c++){var v=o[c],d=v.items;if(lineIsInsidePolygon(d,m,!0)){o.splice(c,1);var h=_split_area(v,m,e);o=o.concat(h);break}}else{var h=_split_area(l,m,e);o=o.concat(h)}}var E=l.weight,A=l.symbols;(E||A)&&o.forEach(function(e){E&&(e.weight=E),A&&(e.symbols=A)}),t[n]=o}var g=[];e.areas.items.forEach(function(e,i){var a=t[i];a?(g=g.concat(a),delete t[i]):g.push(e)}),e.areas.items=g,e.areas.len=g.length}function _get_acreage(e){var i=e.length;if(i>0){for(var a=e[0],s=maxx=a.x,t=maxy=a.y,n=1;i>n;n++){var r=e[n],l=r.x,o=r.y;s>l&&(s=l),l>maxx&&(maxx=l),t>o&&(t=o),o>maxy&&(maxy=o)}return(maxx-s)*(maxy-t)}return 0}function _sort_areas(e){e.items.sort(function(e,i){return e.area<i.area?1:-1})}function _split_area(e,i,a){for(var s=e.items.slice(),t=e.code_list,n=[],r=i.length,l=0;r>l;){var o=n.length;if(o>0){for(var _=0;o>_;_++){var m=n[_].items,f=_split_area2two(m,i,a,l,t);if(f){var c=f.areas;c&&c.length>0&&(n.splice(_,1),n=n.concat(c)),l=f.start_line_index;break}}if(_==o)break}else{var f=_split_area2two(s,i,a,l,t);if(!f)break;var c=f.areas;c&&c.length>0&&(n=n.concat(c)),l=f.start_line_index}}return n}function _split_area2two(e,i,a,s,t){s||(s=0);for(var n,r,l,o,_,m,f,c,v,d,h,E,A=[],g=[],u=i.length,L=s;u>L;L++){var y=i[L],O=isInsidePolygon(e,y.x,y.y);if(O?(m?h=y:m=y,g.push(y)):_&&m?E=y:_=y,_&&m&&h&&E){s=L;break}}if(s!=u&&_&&m&&h&&E){n=_.x,r=_.y,l=m.x,o=m.y,f=h.x,c=h.y,v=E.x,d=E.y;var I,x,N,p;n!=l&&(I=(r-o)/(n-l),x=(n*o-l*r)/(n-l)),f!=v&&(N=(c-d)/(f-v),p=(f*d-v*c)/(f-v));for(var S=_jiaodian_end=null,L=0,M=e.length-1,F=M+1,L=0,G=e.length-1,M=G-1;G>L;M=L++){var R=e[L].x,P=e[M].x,B=e[L].y,T=e[M].y,F=b=void 0;if(R!=P&&(F=(B-T)/(R-P),b=(R*T-P*B)/(R-P)),F!=I){if(0==F)if(void 0!=I)var C=(b-x)/I,D=B;else var C=n,D=b;else if(0==I)if(void 0!=F)var C=(x-b)/F,D=r;else var C=R,D=x;else if(void 0==F)var C=R,D=I*R+x;else if(void 0==I)var C=n,D=F*n+b;else var C=(x-b)/(F-I),D=(F*x-b*I)/(F-I);C>=Math.min(R,P)&&C<=Math.max(R,P)&&C>=Math.min(n,l)&&C<=Math.max(n,l)&&D>=Math.min(B,T)&&D<=Math.max(B,T)&&D>=Math.min(r,o)&&D<=Math.max(r,o)&&(S=[C,D,L,M])}if(F!=N){var C,D;if(0==F)if(void 0!=N)var C=(b-p)/N,D=B;else var C=f,D=b;else if(0==I)if(void 0!=F)var C=(p-b)/F,D=c;else var C=R,D=p;else if(void 0==F)var C=R,D=N*R+p;else if(void 0==N)var C=f,D=F*f+b;else var C=(p-b)/(F-N),D=(F*p-b*N)/(F-N);C>=Math.min(R,P)&&C<=Math.max(R,P)&&C>=Math.min(f,v)&&C<=Math.max(f,v)&&D>=Math.min(B,T)&&D<=Math.max(B,T)&&D>=Math.min(c,d)&&D<=Math.max(c,d)&&(_jiaodian_end=[C,D,L,M])}}if(S&&_jiaodian_end){var Y=S[2],j=_jiaodian_end[2],w=[],k=[];Y>j?(w=e.slice(j,Y+1).reverse(),k=e.slice(Y).concat(e.slice(0,j))):(w=e.slice(Y,j+1),k=e.slice(j).concat(e.slice(0,Y)).reverse()),w[0].x=S[0],w[0].y=S[1],w[w.length-1].x=_jiaodian_end[0],w[w.length-1].y=_jiaodian_end[1];{var W=g[0];g[g.length-1]}Math.pow(S[0]-W.x,2)+Math.pow(S[1]-W.y,2)>Math.pow(_jiaodian_end[0]-W.x,2)+Math.pow(_jiaodian_end[1]-W.y,2)||(w.reverse(),k.reverse()),S[0]!=W.x&&S[1]!=W.y&&(w.splice(-1,1,{x:S[0],y:S[1],z:0}),w.splice(0,1,{x:_jiaodian_end[0],y:_jiaodian_end[1],z:0}),k.splice(-1,1,{x:S[0],y:S[1],z:0}),k.splice(0,1,{x:_jiaodian_end[0],y:_jiaodian_end[1],z:0})),A=[g.concat(w),g.concat(k)]}return A.forEach(function(e,i){A[i]={area:_get_acreage(e),code_list:t,len:e.length,items:e,type:"add"}}),{areas:A,start_line_index:s}}}function _add_area_code(e){var i=[],a=e.areas.items,s=e.symbols.items;a.forEach(function(e,a){var t=e.items,n=[];s.forEach(function(e){var i=e.type;if(CODE_SNOW==i||CODE_RAIN==i||CODE_RAIN_SNOW==i||CODE_MORE==i){var a=isInsidePolygon(t,e.x,e.y);a&&n.push(e)}});var r=n.length;e.code_list=n;for(var l=0;r>l&&n[l].type==CODE_MORE;l++);r>0&&l==r&&i.push(a)});for(var t=0,n=i.length;n>t;t++)for(var r=i[t],l=a[r],o=l.items,_=r-1;_>=0;_--){var m=a[_];if(polygonIsInsidePolygon(m.items,o)){l.code_list=l.code_list.concat(m.code_list.slice());break}}}function _deal_code_list_after_parsearea(e){var i=e.areas;_sort_areas(i),i=i.items;var a=[];if(i){for(var s=0,t=i.length;t>s;s++){var n=i[s],r=n.items,l=n.code_list;if(l){var o,_=[];l.forEach(function(e){var i=e.type;isInsidePolygon(r,e.x,e.y)&&i!=CODE_MORE&&(-1==_.indexOf(i)&&_.push(i),o=i)}),n.code=o,n.code_list=_;0!=_.length||a.push(s)}}for(var m=i.length,s=(e.symbols.items,0),t=a.length;t>s;s++)for(var f=a[s],c=i[f],v=c.items,d=v.length,h=0;m>h;h++)if(h!=f){var E=i[h],A=polygonIsInsidePolygon(E.items,v,!0);if(A>=d-6){c.code_list=E.code_list,c.code=E.code;break}}for(var s=0,t=m;t>s;s++){var c=i[s],g=c.items;if(c.code==CODE_RAIN_SNOW)for(var u=s+1;m>u;u++){{var L=i[u],y=L.items;y.length}L.code!=CODE_RAIN_SNOW&&polygonIsInsidePolygon(g,y)&&(L.code=CODE_RAIN_SNOW)}}}}function _format(e){var i=e.line_symbols.items,a=i.length;a>0?(e.line_symbols.items=i,e.line_symbols.len=a):delete e.line_symbols;var s=e.areas;_deal_code_list_after_parsearea(e);var t=s.items;if(t.forEach(function(e){delete e.len;var i=e.symbols;i&&delete i.len,delete e.code_list}),e.areas=t,e.line_symbols){var n=e.line_symbols.items;n.forEach(function(e){delete e.len}),e.line_symbols=n}var r=e.lines.items;r.forEach(function(e){delete e.flags.len,e.point=e.point.items}),e.lines=r,e.symbols=e.symbols.items}var util=require("util"),utils=require("../utils"),isInsidePolygon=utils.isInsidePolygon,isInLeftTopLine=utils.isInLeftTopLine,lineIsInsidePolygon=utils.lineIsInsidePolygon,polygonIsInsidePolygon=utils.polygonIsInsidePolygon,CODE_SNOW=23,CODE_RAIN=26,CODE_RAIN_SNOW=24,CODE_MORE=48;exports.parse=_parse_file;