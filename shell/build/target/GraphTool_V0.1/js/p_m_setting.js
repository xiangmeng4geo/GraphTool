Core.safe(function(){function e(e){var n=W._treeitem,i=n.path,a=0;$.each(e,function(e,t){if(M(t.name)){var o=t.path,c=r.join(i,t.name);o!=c&&l.copy(o,c)&&(n.files.push(c),a++)}}),t(),alert(a?"成功导入"+a+"个图片！":"没有找到图片！")}function t(){var e=W._treeitem,t=e.path,i=l.readdir(t);e.files=i,n($("fieldset.on .tree_right ul"),i)}function n(e,t){var n="";t&&t.length>0?$.each(t,function(e,t){var i=t.name,a=r.extname(i);if(M(a)){var o=r.basename(i).replace(a,"");n+='<li><div><img src="'+i+'"/><span>'+o+"</span></div></li>"}}):n+='<li class="no_files">暂时无可以显示的文件</li>',e.html(n)}function i(e,t,i){function a(e,t){void 0!=t?t+="_":t="",void 0!=t||(t="r");var n=[],i=[];return e&&e.length>0&&$.each(e,function(e,o){var c=t+e,l=!!o.sub;if(l){var s={id:c,text:r.basename(o.name),showcheck:!0,complete:!1,isexpand:!0,checkstate:0,path:o.name},p=a(o.sub,c),f=p[0];f.length>0&&(s.ChildNodes=f,s.hasChildren=!0),s.files=p[1],n.push(s)}else i.push(o)}),[n,i]}var o=l.readdir(i),c=a(o)[0],s=$("#"+t);s.click(function(e){var t=$(e.target);(t.is("li")||(t=t.closest("li")).length>0)&&(t.hasClass("on")?t.removeClass("on"):t.addClass("on"))}),$("#"+e).treeview({data:c,showcheck:!1,cbiconpath:"img/jquery.tree/",onnodeclick:function(e){n(s,e.files)},onnodecontextmenu:function(e,t){W._treeitem=t,W._contextmenu_e=e,W.popup(e.clientX,e.clientY)},onnodedblclick:function(){}})}var a="系统",o=Core.Lib.util,c=Core.Lib.conf.User,l=o.file,r=o.path,s=l.path,p=s.icon,f=s.image,h=Core.Window,d=Core.Const.projector,u=$("#c_bottom > fieldset"),m=$("#c_top li").click(function(){var e=$(this);m.removeClass("on"),e.addClass("on"),u.removeClass("on"),u.eq(e.index()).addClass("on")});$(".file_dir").click(function(){$(this).parent().prev().click()}),$(".file_dir_nw").on("change",function(){var e=$(this);e.next().find(".text_file_dir").val(e.val())}),$(".logos .file_dir_nw").attr("nwworkingdir",l.path.icon);var v=$("#text_file_southsea_logo"),_=$("#text_file_company_logo"),g=$("#checkbox_show_southsea"),k=$("#checkbox_show_logo"),b=$("#select_map_projector"),w=c.get(a),C="";if(w){var x=w.logos;if(x){var j=x.southsea;j&&(g.prop("checked",j.flag),v.val(j.p));var y=x.company;y&&(k.prop("checked",y.flag),_.val(y.p))}C=w.projector}var I="";$.each(d,function(e,t){var n=t.v;I+='<option value="'+n+'" '+(n==C?"selected":"")+">"+t.n+"</option>"}),b.html(I),$("#btn_cancel").click(h.close),$("#btn_save").click(function(){var e={logos:{southsea:{flag:g.prop("checked"),p:v.val()},company:{flag:k.prop("checked"),p:_.val()}},projector:b.val()};c.write(a,e,!0),h.close()});var M=Core.util.isImg,h=Core.Window,N=h.getGui(),q=N.Menu,L=N.MenuItem,W=new q,G=new L({label:"从文件导入"}),U=new L({label:"从文件夹导入"}),X=new L({label:"新建资源库"}),Y=new L({label:"删除资源库"});G.on("click",function(){$('<input type="file" multiple accept=".jpg,.gif,.bmp,.png"/>').on("change",function(){var t=$(this)[0].files;e(t)}).click()}),U.on("click",function(){$('<input type="file" multiple accept=".jpg,.gif,.bmp,.png" nwdirectory/>').on("change",function(){var t=$(this).val(),n=W._treeitem,i=(n.path,l.readdir(t)),a=[];$.each(i,function(e,t){var n=t.name;a.push({name:r.basename(n),path:n})}),e(a)}).click()}),X.on("click",function(){var e=prompt("请输入资源库名称！");if(e){var t=W._treeitem,n=t.path,i=l.mkdir(r.join(n,e));alert("操作"+(i?"成功":"失败")+"!"),i&&$(W._contextmenu_e.target).closest(".bbit-tree").addNode({text:e,showcheck:!0,complete:!0,isexpand:!0,checkstate:1,path:r.join(n,e),files:[]})}}),Y.on("click",function(){if(confirm("确定要删除资源库吗？")){var e=W._treeitem,t=e.path,n=l.rm(t);alert("操作"+(n?"成功":"失败")+"!"),n&&$(W._contextmenu_e.target).closest(".bbit-tree").rmNode(e.id)}}),W.append(G),W.append(U),W.append(new N.MenuItem({type:"separator"})),W.append(X),W.append(Y),i("tree_icon","file_list_icon",p),i("tree_image","file_list_image",f)});