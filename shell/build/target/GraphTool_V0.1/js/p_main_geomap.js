Core.safe(function(){function e(e,t){if(!a||!i)return e;var n=a.in_out.file_rule,o=n.file_type||v.shikuang.v,r=n.file_hour||0,s=new Date(t?i.mtime:i.time);if(v.forecast.v!=o||t)e=s.format(e);else{var l=new Date(s.getTime());l.setHours(l.getHours()+r);var c=new Date(l.getTime());c.setHours(c.getHours()+Math.min(24,r)),e=l.format(e),e=c.format(e)}return e}function t(t){f.onMessage(function(e){var t=e.data,n=t.type;if(u.CONF_STYLE==n){t=t.data;var o=t.style,a=t.text,i={};if(o){var r=o.split(/;\s*/);$.each(r,function(e,t){var n=t.split(/:\s+/);n[0]&&(i[n[0]]=n[1])})}if(!l){var s=c?{left:c.offsetX,top:c.offsetY}:{left:z/2,top:z/2};l=D.text({position:s}).appendTo(A)}l.css(i).find("span").text(a),l=null}}),O=!0,require(["GeoMap","LegendImage"],function(n,l){function c(e,t,o){function a(e,t){for(var n=0,o=t.length;o>n;n++){var a=t[n],i=a.val;if(e>=i[0]&&e<i[1])return a.color}}function i(e,n){if(!d)return a(e,t[0].colors);for(var o=0,i=t.length;i>o;o++){var r=t[o];if(n==r.val.v)return a(e,r.colors)}}gm.addOverlay(new n.Rectangle({style:{x:0,y:0,width:z,height:L,color:r.bgcolor||"#ffffff"}}));for(var s=0,l=t.length;l>s;s++)for(var c=t[s].colors,f=0,p=c.length;p>f;f++){var u=c[f].val;""===u[0]&&(u[0]=Number.NEGATIVE_INFINITY),""===u[1]&&(u[1]=Number.POSITIVE_INFINITY)}g.start("render micaps");var d=t.length>1,h=e.interpolate;if(h){var m,_,w="rgba(0,0,0,0)";try{m=h.length,_=h[0].length}catch(y){}for(var b=[],s=0;m>s;s++){for(var C=[],l=0;_>l;l++){var k=h[s][l],I=i(k.v);C.push({x:k.x,y:k.y,c:I||w})}b.push(C)}g.start("raster2vector");var M=x.micaps.raster2vector(b,w,o);g.end("raster2vector",1);for(var s=0,l=M.length;l>s;s++){for(var T=[],N=M[s],I=N.color,E=0,P=N.items,O=P.length;O>E;E++){var k=P[E],G=new n.Point(k.lng,k.lat);T.push(G)}var D=new n.Polygon(T,{style:{strokeColor:w,color:I}});gm.addOverlay(D)}}var F=e.areas;F&&$.each(F,function(e,t){var o=[];$.each(t.items,function(e,t){var a=new n.Point(t.x,t.y);o.push(a)});var a=v[Math.floor(Math.random()*v.length)],r="rgba(0,0,0,0)",s=t.symbols,l=s?s.text:"";r=i(l,t.code),a=r,24==t.code&&(a=new n.Pattern.Streak({strokeStyle:r,space:1}));var c=new n.Polygon(o,{style:{strokeColor:r,color:a,lineWidth:.2}});gm.addOverlay(c)});var A=e.line_symbols;if(A){var Y={2:"blue",3:"red",38:"red"};$.each(A,function(e,t){if(0!=t.code){var o=[];$.each(t.items,function(e,t){var a=new n.Point(t.x,t.y);o.push(a)});var a={code:t.code,width:20,space_point:10};38==t.code&&(a.width=10,a.space_point=8);var i=new n.Polyline(o,{style:{strokeColor:Y[t.code],lineWidth:2},zlevel:10},a);gm.addOverlay(i)}})}var R=e.lines;R&&$.each(R,function(e,t){var o=[],a=t.point;if(a.length>=2){$.each(a,function(e,t){var a=new n.Point(t.x,t.y);o.push(a)});var i=new n.Polyline(o,{style:{strokeColor:"#1010FF",lineWidth:2},zlevel:n.ZLEVEL.NOCLIP});gm.addOverlay(i)}var r=t.flags;if(r&&r.items&&r.items.length>0){var s=r.text;$.each(r.items,function(e,t){gm.addOverlay(new n.Text(s,"left:"+t.x+"px;top:"+t.y+"px;font-size: 12px"))})}});var S=e.symbols;S&&$.each(S,function(e,t){var o=t.type,a="",i="#1010FF";"60"==o?(a="H",i="red"):"61"==o?a="L":"37"==o&&(a="台",i="green");var r=new n.Text(a,"color:"+i+";left:"+t.x+"px;top:"+t.y+"px;font-size: 30px",null,{pos:{x:t.x,y:t.y},zlevel:n.ZLEVEL.NOCLIP});gm.addOverlay(r)}),g.end("render micaps")}var f=m.getSys(),p=f&&f.projector||n.PROJECT_MERCATOR;window.GeoMap=n,s=l,gm=new n({container:T,mirror:!0,projector:p}),!function(){var e,t=1.2;F.on("mousewheel",function(n){clearTimeout(e),e=setTimeout(function(){gm.zoom(n.originalEvent.wheelDelta>0?t:1/t,{x:n.offsetX,y:n.offsetY})},30)}),gm.draggable()}();var u=$("#map_tool div").click(function(){u.removeClass("on"),$(this).addClass("on")});$("#map_tool_reset").click(function(){gm.reset(!0)}),G.show();var v=["red","blue","#000","#123","#f26","#ccc","#333"],h="./data/china_province."+p+".json";gm.loadGeo([h],{style:{maskColor:"white"},is_show_mask:t},function(){function t(t,n,o){if(t&&t.is_show){var a=t.text;if(a)return D.text({position:n,text:e(a,o),style:t.style}).appendTo(A)}}function n(){O=!1,G.hide(),gm.refresh()}G.hide(),E.on(d.PRODUCT_CHANGE,function(s,l){l&&($(".map_layer").remove(),gm.clearLayers(),F.removeAttr("style"),G.show(function(){function s(e,t){var n=u.logo_southsea;n&&n.flag?o(n.p,e,t):t&&t()}function f(e){var n=y.title_3;if(n){if(!T){var o=/font-size: (\d+)px/.exec(n.style),a=o?parseFloat(o[1])+10:30;isNaN(e.top)?e.bottom+=a:e.top-=a}w=t(n,e,!0),w&&w.data("use_mtime",!0)}}function p(e,t,n,o){new D.img({position:e,width:t,height:n,src:P},function(e,t){A.append(e),o&&o(e,t)})}if(a=m.get(l),!(a&&a.title&&a.legend&&a.in_out))return G.hide(),alert("请对该产品进行配置！");a.name=l;var u=a.other,d=u.logo;d&&o(d,{left:20,top:20}),r={};var v=!1,h=u.bg_img;if(h&&h.flag&&h.val&&(F.css("background-image",'url("'+h.val.replace(/\\/g,"/")+'")'),v=!0,r.bgimg=h.val),!v){var _=u.bg_color;_&&_.flag&&_.val&&(F.css("background-color",_.val),r.bgcolor=_.val)}var w,y=a.title||{},b=t(y.title_1,{left:110,top:20}),k=t(y.title_2,{left:110,top:80}),I=a.legend,M=I.is_show_legend,T=I.is_updown,E=A.width();if(M){var P=N(l,z,L),O=new Image;O.onload=function(){var e=this.width,t=this.height;if(T){var n=E/1024,o=e*n,a=t*n;s({left:10,top:"auto",bottom:10},function(e,t){if(e&&t)var n={left:10+t.width_show+10,top:"auto",bottom:10};else var n={left:10,top:"auto",bottom:10};p(n,o,a),f({left:"auto",right:10,top:"auto",bottom:10})})}else{var o=Math.min(e,E),a=o*t/e;p({left:0,top:"auto",bottom:0},o,a,function(e,t){var n=e.position();f({left:10,top:n.top}),s({left:"auto",right:10,top:"auto",bottom:t.height_show+10})})}},O.onerror=O.onload,O.src=P}else{var Y,R;T?(Y={left:10,top:"auto",bottom:10},R={left:"auto",right:10,top:"auto",bottom:10}):(Y={left:"auto",right:10,top:"auto",bottom:10},R={left:10,top:"auto",bottom:10}),s(Y),f(R)}var S=a.in_out,U=S.dir_in;if(x.exists(U)){var j=[U],V=a.file,X=S.file_rule;if("1"==X.type){var H=X.common;j.push(H.prefix+H.date_format+H.postfix+"."+H.file_suffix)}else j.push(X.custom);V.is_newest?j.push(V.newest_days):(j.push(V.time_start),j.push(V.time_end));var B=C.getNewest.apply(null,j);if(B){g.start("read micaps");var W=u.interpolation;x.micaps.getData(B,{val_col:X.col,grid_space:.2,interpolation_all:W&&W.flag},function(t,o,r){g.end("read micaps"),t?alert(t.msg||"读取数据错误！"):(b&&b.find("span").text(function(){return e($(this).text())}),k&&k.find("span").text(function(){return e($(this).text())}),w&&w.find("span").text(function(){return e($(this).text(),!0)}),i=o,c(i,a.legend.blendent,r)),n()})}else alert("没有找到符合条件的文件，请检查产品相关配置！"),n()}else alert("请配置该产品的数据源路径！"),n()}))}),E.trigger(d.GEOMAP_INITED)})})}function n(){var t;try{t=e(a.in_out.out_filename)}catch(n){}return t||a.name+"_"+z+"x"+L+".png"}function o(e,t,n){D.img({position:t,src:e},function(e,t){A.append(e),n&&n(e,t)})}var a,i,r,s,l,c,f=Core.Window,p=Core.Const,u=p.msgType,d=p.Event,v=p.fileRule.file_type,h=(Core.Color.toRGB,Core.util.Logger),g=h.Timer,m=Core.Lib.conf.User,_=f.getGui(),w=_.Menu,y=_.MenuItem,b=Core.Lib.util,x=b.file,C=x.micaps,k=b.path,I=x.path,M=I.icon,T=(I.image,$("#geomap")),z=T.width(),L=T.height(),N=function(){var e=x.tmp.legend;return function(t,n,o){var i=e.getPath(t,n,o);return e.isNew(t,n,o)||s(i,a.legend),i+"?"+Math.random()}}(),E=$(document),P=Core.util.isImg;Core.Html.addScript("./js/libs/esl.js",!1,function(){var e="./js/libs/zr";require.config({paths:{zrender:e,"zrender/shape/Base":e,"zrender/shape/BrokenLine":e,"zrender/shape/Polygon":e,"zrender/Group":e,"zrender/tool/util":e,"zrender/tool/area":e,"zrender/shape/Image":e,"zrender/shape/Text":e,"zrender/shape/Rectangle":e,GeoMap:"./js/libs/GeoMap",LegendImage:"./js/libs/LegendImage"}}),t(!0)});var O=!1,G=function(){function e(e){n||(n=$('<div class="loading"><div>正在处理。。。</div></div>').appendTo(F)),n.show(e)}function t(){n&&n.hide()}var n;return{show:e,hide:t}}(),D=function(){function e(e){var t=o._layer;if(t){var n=t.position(),a=n.left,i=n.top,r=t.width(),s=t.height(),l=i+s,c=a+r,f=(parseInt(t.css("z-index"))||0,Number.MIN_VALUE),p=Number.MAX_VALUE,u=$(".map_layer").filter(function(){var e=$(this);if(!e.is(t)){var n=e.width(),o=e.height(),r=e.position(),s=r.left,f=r.top,p=Math.max(s,a),u=Math.max(f,i),d=Math.min(s+n,c),v=Math.min(f+o,l);if(d>p&&v>u)return e}}).each(function(){var e=$(this),t=parseInt(e.css("z-index"))||0;t>f?f=t:p>t&&(p=t)});if(f!=Number.MIN_VALUE||p!=Number.MAX_VALUE){var d=e?f+1:p-1;if(0>d){var v=-d;u.each(function(){$(this).css("z-index",(parseInt($(this).css("z-index"))||0)+v)}),d=0}t.css("z-index",d)}}}function t(e){var t=e.position,n=e.ondblclick,a=$('<div class="texteditor map_layer">'),i=e.style;return i&&a.attr("style",i),a.html("<span>"+(e.text||"")+"</span>").css(t).addClass("off").resizable().draggable().css("position","absolute").on("mouseenter",function(){$(this).removeClass("off")}).on("mouseleave",function(){$(this).addClass("off")}).on("dblclick",function(){var e=$(this),t=e.text(),o=e.attr("style"),a=Core.Page.textStyle(function(){f.sendMsg(u.CONF_STYLE,{text:t,style:o},a.window)});l=e,n&&n.call(this)}).on("contextmenu",function(e){e.stopPropagation(),o._layer=$(this),o.popup(e.clientX,e.clientY)}),a}function n(e,t){var n=e.position,a=e.src,i=new Image;i.onload=function(){var a=this.width,i=this.height,r=80,s=80*i/a;e.width&&e.height&&(r=e.width,s=e.height);var l=$('<div class="map_layer map_layer_image off"><img src="'+e.src+'"></div>').css(n).css({width:r,height:s}).resizable().draggable().css("position","absolute");l.on("mouseenter",function(){$(this).removeClass("off")}).on("mouseleave",function(){$(this).addClass("off")}).on("contextmenu",function(e){e.stopPropagation(),o._layer=$(this),o.popup(e.clientX,e.clientY)}),t(l,{width:a,height:i,width_show:r,height_show:s})},i.src=a}var o=new w,a=new y({label:"删除"});a.on("click",function(){var e=o._layer;e&&e.remove()});var i=new y({label:"置于上层"});i.on("click",function(){e(!0)});var r=new y({label:"置于下层"});return r.on("click",function(){e(!1)}),o.append(a),o.append(new _.MenuItem({type:"separator"})),o.append(i),o.append(r),{text:t,img:n}}(),F=$("#geomap_container"),A=F;!function(){var t=function(){gm&&a?$('<input type="file" nwsaveas="'+n()+'" nwworkingdir="'+a.in_out.dir_out+'"/>').on("change",function(){g.start("save image");var t=$(this).val();G.show(function(){function n(){o=i.toDataURL(r),x.img.saveBase64(t,o),a.remove(),G.hide();var e=g.end("save image");alert("成功导出图片, 用时"+e+"毫秒!")}var o=gm.toDataURL(),a=$('<div style="position: absolute; left: -999px;top: 0;width: '+z+"px; height: "+L+'px"></div>').appendTo($("body")),i=new GeoMap({container:a});i.addOverlay(new GeoMap.Image(o));A.find(".map_layer").sort(function(e,t){return $(e).css("z-index")>$(t).css("z-index")}).each(function(){var t=$(this);if(t.is(".texteditor")){t.css(t.position());var n=parseFloat(t.css("padding-top"))||0,o=parseFloat(t.css("padding-right"))||0,a=parseFloat(t.css("padding-bottom"))||0,r=parseFloat(t.css("padding-left"))||0;i.addOverlay(new GeoMap.Text(e(t.text()),t.attr("style"),[n,o,a,r]))}else if(t.is(".map_layer_image")){var s=t.position(),l=t.find("img").get(0);i.addOverlay(new GeoMap.Image(l,s.left,s.top,t.width(),t.height()))}});var s=r.bgimg;if(s&&x.exists(s)){var l=new Image;l.onload=function(){r.bgimg=l,n()},l.src=s}else n()})}).click():alert("请先选择要操作的产品！")},i=function(){var e=Core.Page.textStyle(function(){f.sendMsg(u.CONF_STYLE,{},e.window)})},s=function(){function e(e,t){var n="";$.each(t,function(e,t){var o=k.basename(t);P(o)&&(o=o.replace(k.extname(t),""),n+='<li><img src="'+t+'" draggable="true"/><span>'+o+"</span></li>")}),e.html(n)}function t(){function t(e,n,o){var a="",i=!!e.sub;if(i){for(var s="",l=0;n>l;l++)s+="　　";s&&(s+="|--");var c=n+"_"+o,f=e.name,p=k.basename(f),u="",d=[];$.each(e.sub,function(e,o){o.sub||d.push(o.name),u+=t(o,1+n,e)}),r[c]=d,a+='<option value="'+c+'">'+s+p+"</option>",a+=u}return a}if(!a||i){var r={};a=x.readdir(M),n||(n=$('<div class="tool_image"><div class="btn_close_tool_image"></div><div class="tool_image_main"></div></div>').appendTo("#c_right"),n.delegate("select","change",function(){e(n.find("ul"),r[$(this).val()])}),n.delegate(".btn_close_tool_image","click",function(){n.slideUp()}),o=n.find(".tool_image_main"));var s="<select>";$.each(a,function(e,n){s+=t(n,0,e)}),s+="</select>",o.children().remove(),o.html(s+'<ul class="clear"></ul>'),e(o.find("ul"),r[o.find("select").val()])}}var n,o,a,i=!1;return $("#btn_setting").click(function(){i=!0}),function(){t(),n.slideDown()}}();$("#btn_add_text").click(i),$("#btn_add_img").click(s),$("#btn_export").click(t),A.on("contextmenu",function(e){c=e;var n=$(this),a=n.data("menu");if(!a){a=new w;var r=new y({label:"添加文字"});r.on("click",i);var l=new y({label:"添加外部图片"});l.on("click",function(){$('<input type="file" nwworkingdir="'+x.path.image+'" />').on("change",function(){o($(this).val(),{left:A.width()/2,top:A.height()/2})}).click()});var f=new y({label:"添加图片库图片"});f.on("click",s);var p=new y({label:"导出图片"});p.on("click",t),a.append(r),a.append(new _.MenuItem({type:"separator"})),a.append(l),a.append(f),a.append(new _.MenuItem({type:"separator"})),a.append(p),n.data("menu",a)}a.popup(e.clientX,e.clientY)})}(),A.on("dragover",function(e){e.preventDefault()}).on("dragenter",function(e){e.preventDefault()}).on("drop",function(e){e.preventDefault(),e.stopPropagation(),e=e.originalEvent;var t=e.dataTransfer,n=t.getData("Text"),a=e.offsetX,i=e.offsetY;if(n&&P(n))o(n,{left:a,top:i});else{var r=t.files;r.length>0&&$.each(r,function(e,t){o(t.path,{left:a+10*e,top:i+10*e})})}return!1})});