<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>用户身份验证</title>
		<link rel="stylesheet" type="text/css" href="css/reset.css">
		<style>
		.row{
			width: 220px;
			margin: 10px auto;
		}
		.row h1{
			text-align: center;
		}
		.row label{
			display: inline-block;
			width: 60px;
		}
		#btn_login{
			float: left;
			margin-left: 40px;
		}
		#btn_cancel{
			float: right;
			margin-right: 40px;
		}
		input[type=checkbox]{
			vertical-align: -2px;
		}
		.initializing{
			width: 100%;
			height: 100%;
			position: fixed;
			background-color: rgba(0,0,0,.5);
			color: white;
			left: 0;
			top: 0;
			display: none;
		}
		.initializing span{
			position: absolute;
			width: 100%;
			height: 30px;
			line-height: 30px;
			left: 0;
			top: 40%;
			text-align: center;
			font-size: 24px;
		}
		</style>
	</head>
	<body>
		<script type="text/javascript" src="./js/libs/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="./js/core.js"></script>
		<div class="initializing"><span>系统正在初始化。。。</span></div>
		<div class="row">
			<h1>用户登录</h1>
		</div>
		<div class="row">
			<label>用户名:</label><input type="text" id="username" placeholder="用户名"/>
		</div>
		<div class="row">
			<label>密　码:</label><input type="password" id="userpwd" placeholder="密码"/>
		</div>
		<div class="row">
			<input type="checkbox" id="cb_remember"/><label for="cb_remember">记住密码</label>
			<input type="checkbox" id="cb_autologin"/><label for="cb_autologin">自动登录</label>
		</div>
		<div class="row">
			<input type="button" value="登录" id="btn_login"/>
			<input type="button" value="取消" id="btn_cancel"/>
		</div>
		<script type="text/javascript">
		Core.safe(function(){
			var core = require('core');
			var conf = core.conf;
			var util = core.util,
				Store = Core.Store;

			var Window = require('nw.gui').Window;
			var win = Window.get();
			$('#btn_cancel').click(function(){
				win.close();
			});
			var $username = $('#username'),
				$userpwd = $('#userpwd');
			var verification = conf.getVerification();
			function wrapPwd(pwd){
				return util.encrypt(pwd,verification.key);
			}
			function login(name,pwd,is_autologin){
				if(!is_autologin){
					pwd = wrapPwd(pwd);
				}
				return (name == verification.name && pwd == verification.pwd)
			}
			var $cb_remember = $('#cb_remember'),
				$cb_autologin = $('#cb_autologin');
			var is_remember = Store.get('user_is_remember',false);
			$cb_remember.prop('checked',is_remember);

			var is_encrypt = false;
			if(is_remember){
				var pwd = Store.get('user_pwd');
				if(pwd){
					is_encrypt = true;
					$userpwd.on('change',function(){
						is_encrypt = false;
					});
				}
				$userpwd.val(pwd);
			}
			var is_autologin = Store.get('user_is_autologin',false);
			$cb_autologin.prop('checked',is_autologin);
			if(is_autologin){
				var name = Store.get('user_name');
				var pwd = Store.get('user_pwd');
				if(name && pwd){
					return afterLogin(login(name,pwd,true));
				}
			}
			win.showDevTools();
			win.show();
			win.focus();
			function afterLogin(login_flag,true_fn,false_fn){
				if(login_flag){
					var $initializing = $('.initializing').show();
					var start_time = new Date();
					var min_init_time = 2000;
					(true_fn || function(){})();
					var win_index = Window.open('./main.html',conf.get('view_main'));
					var fn_inited = function(){
						var init_time = (new Date()-start_time)/1000;
						win_index.removeAllListeners();
						setTimeout(function(){
							win_index.show();
							win_index.focus();
							win.close();
						},min_init_time-init_time);
					}
					win_index.once('inited',fn_inited);
				}else{
					(false_fn || function(){
						alert('您输入的用户和密码错误，请重新输入！');
					})();
				}
			}

			$username.val(Store.get('user_name'));
			
			Core.Window.onKeyEnter(function(){
				$btn_login.click();
			});
			var $btn_login = $('#btn_login').click(function(){
				var username = $username.val();
				if(!username){
					return alert('请输入用户名!');
				}
				var pwd = $userpwd.val();
				if(!pwd){
					return alert('请输入密码!');
				}

				afterLogin(login(username,pwd,is_encrypt),function(){
					Store.set('user_name',username);
					var is_remember = $cb_remember.prop('checked');
					Store.set('user_is_remember',is_remember);
					var is_autologin = $cb_autologin.prop('checked');
					Store.set('user_is_autologin',is_autologin);
					if(is_remember){
						Store.set('user_pwd',is_encrypt?pwd:wrapPwd(pwd));
					}else{
						Store.rm('user_pwd');
					}
				});
			});
		});
		</script>
	</body>
</html>
